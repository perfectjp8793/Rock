<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>オンラインジャンケン</title>
</head>
<body>
    <h1>オンラインジャンケン</h1>

    <button id="createRoomBtn">ルームを作る</button>
    <button id="joinRoomBtn">ルームに参加</button>

    <h2>あなたの手を選ぶ</h2>
    <button id="rockBtn">グー</button>
    <button id="scissorsBtn">チョキ</button>
    <button id="paperBtn">パー</button>

    <h2 id="result"></h2>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // ✅ Firebaseの設定
        const firebaseConfig = {
            apiKey: "AIzaSyDz7bUkG8_thmFr4Alot_FXyxl8dex0B18",
            authDomain: "jankenonline-270a1.firebaseapp.com",
            projectId: "jankenonline-270a1",
            storageBucket: "jankenonline-270a1.appspot.com", // 修正
            messagingSenderId: "573769462418",
            appId: "1:573769462418:web:4ad6efd0fac2af48deec4b"
        };

        // ✅ Firebaseを初期化
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let roomId = null;
        let playerId = Math.random().toString(36).substring(2, 10); // ランダムなID

        // ✅ ルームを作成する
        async function createRoom() {
            const roomRef = await addDoc(collection(db, "rooms"), {
                player1: playerId,
                player2: null,
                player1Hand: null,
                player2Hand: null
            });
            roomId = roomRef.id;
            alert(`ルーム作成！ID: ${roomId}`);
        }

        // ✅ ルームに参加する
        async function joinRoom() {
            const inputId = prompt("参加するルームIDを入力:");
            const roomRef = doc(db, "rooms", inputId);
            const roomSnap = await getDoc(roomRef);

            if (roomSnap.exists()) {
                const roomData = roomSnap.data();
                if (!roomData.player2) {
                    await setDoc(roomRef, { player2: playerId }, { merge: true });
                    roomId = inputId;
                    alert("ルームに参加しました！");
                } else {
                    alert("満員です！");
                }
            } else {
                alert("ルームが見つかりません！");
            }
        }

        // ✅ ジャンケンの手を出す
        async function playGame(hand) {
            if (!roomId) {
                alert("ルームに入っていません！");
                return;
            }

            const roomRef = doc(db, "rooms", roomId);
            const roomSnap = await getDoc(roomRef);
            const roomData = roomSnap.data();

            if (roomData.player1 === playerId) {
                await setDoc(roomRef, { player1Hand: hand }, { merge: true });
            } else if (roomData.player2 === playerId) {
                await setDoc(roomRef, { player2Hand: hand }, { merge: true });
            }

            checkResult();
        }

        // ✅ 勝敗判定
        async function checkResult() {
            const roomRef = doc(db, "rooms", roomId);
            const roomSnap = await getDoc(roomRef);
            const roomData = roomSnap.data();

            if (roomData.player1Hand && roomData.player2Hand) {
                let result = "";
                if (roomData.player1Hand === roomData.player2Hand) {
                    result = "引き分け！";
                } else if (
                    (roomData.player1Hand === "グー" && roomData.player2Hand === "チョキ") ||
                    (roomData.player1Hand === "チョキ" && roomData.player2Hand === "パー") ||
                    (roomData.player1Hand === "パー" && roomData.player2Hand === "グー")
                ) {
                    result = roomData.player1 === playerId ? "あなたの勝ち！" : "相手の勝ち！";
                } else {
                    result = roomData.player2 === playerId ? "あなたの勝ち！" : "相手の勝ち！";
                }

                document.getElementById("result").innerText = result;

                // **リセット**
                await setDoc(roomRef, { player1Hand: null, player2Hand: null }, { merge: true });
            }
        }

        // ✅ ボタンに関数を紐付ける（エラーを防ぐため！）
        document.getElementById("createRoomBtn").addEventListener("click", createRoom);
        document.getElementById("joinRoomBtn").addEventListener("click", joinRoom);
        document.getElementById("rockBtn").addEventListener("click", () => playGame('グー'));
        document.getElementById("scissorsBtn").addEventListener("click", () => playGame('チョキ'));
        document.getElementById("paperBtn").addEventListener("click", () => playGame('パー'));
    </script>
</body>
</html>
